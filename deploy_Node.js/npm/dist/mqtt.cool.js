/*

 https://mqtt.cool
 MQTT.Cool Node.js Client
 Version 2.0.0 build 217
 Copyright (c) Lightstreamer Srl. All Rights Reserved.
 Contains: LightstreamerClient, Subscription, SimpleLoggerProvider, ConsoleAppender,
 LightstreamerMQTT, openSession, Message
 CJS
*/
var e=require("lightstreamer-client-node"),g={toString:function(){return"[MQTT.Cool "+g.library+" client version "+g.version+" build "+g.build+"]"},library:"nodejs",version:"2.0.0",build:"217"},aa=function(){function a(d){this.la(d)}function b(){return!1}var c={error:b,warn:b,info:b,debug:b,fatal:b,isDebugEnabled:b,isInfoEnabled:b,isWarnEnabled:b,isErrorEnabled:b,isFatalEnabled:b};a.prototype={la:function(d){this.g=d||c},A:function(d){this.m()&&(d+=this.h(arguments,1),this.fatal(d))},fatal:function(d,
f){this.g.fatal(d,f)},m:function(){return!this.g.isFatalEnabled||this.g.isFatalEnabled()},I:function(d){this.j()&&(d+=this.h(arguments,1),this.error(d))},u:function(d,f){this.j()&&(f+=this.h(arguments,2),this.error(f,d))},error:function(d,f){this.g.error(d,f)},j:function(){return!this.g.isErrorEnabled||this.g.isErrorEnabled()},J:function(d){this.s()&&(d+=this.h(arguments,1),this.warn(d))},warn:function(d,f){this.g.warn(d,f)},s:function(){return!this.g.isWarnEnabled||this.g.isWarnEnabled()},$:function(d){this.o()&&
(d+=this.h(arguments,1),this.info(d))},info:function(d,f){this.g.info(d,f)},o:function(){return!this.g.isInfoEnabled||this.g.isInfoEnabled()},l:function(d){this.ga()&&(d+=this.h(arguments,1),this.debug(d))},debug:function(d,f){this.g.debug(d,f)},ga:function(){return!this.g.isDebugEnabled||this.g.isDebugEnabled()},h:function(d,f){var k=" {";for(f=f?f:0;f<d.length;f++)try{var h=d[f];null===h?k+="NULL":0>h.length?k+="*":null!=h.charAt?k+=h:h.message?(k+=h.message,h.stack&&(k+="\n"+h.stack+"\n")):h[0]==
h?k+=h:h&&h.join&&"function"==typeof h.join?(k+="(",k+=this.h(h),k+=")"):k+=h;k+=" "}catch(p){k+="??? "}return k+"}"}};a.prototype.debug=a.prototype.debug;a.prototype.isDebugLogEnabled=a.prototype.ga;a.prototype.logDebug=a.prototype.l;a.prototype.info=a.prototype.info;a.prototype.isInfoLogEnabled=a.prototype.o;a.prototype.logInfo=a.prototype.$;a.prototype.warn=a.prototype.warn;a.prototype.isWarnEnabled=a.prototype.s;a.prototype.logWarn=a.prototype.J;a.prototype.error=a.prototype.error;a.prototype.isErrorEnabled=
a.prototype.j;a.prototype.logError=a.prototype.I;a.prototype.logErrorExc=a.prototype.u;a.prototype.fatal=a.prototype.fatal;a.prototype.isFatalEnabled=a.prototype.m;a.prototype.logFatal=a.prototype.A;return a}(),m=function(){var a={},b=null,c={setLoggerProvider:function(d){if(d&&!d.getLogger)throw Error("The given object is not a LoggerProvider");b=d;for(var f in a)b?a[f].la(b.getLogger(f)):a[f].la(null)},U:function(d){a[d]||(a[d]=b?new aa(b.getLogger(d)):new aa);return a[d]},resolve:function(d){return d}};
c.setLoggerProvider=c.setLoggerProvider;c.getLoggerProxy=c.U;c.resolve=c.resolve;return c}(),ba=m.U("mqtt.cool"),n={i:function(a,b,c){ba.debug("Invoking <"+b+"> on ["+a+"] object");var d=a[b];if(d)try{return"undefined"!=typeof c?d.apply(a,c):d.apply(a)}catch(k){var f=k;ba.error("Exception ["+k+"] while invoking <"+b+"> on ["+a+"] object");throw Error(k);}finally{f||ba.debug("<"+b+"> successfully invoked.")}},fb:function(a){if(void 0!==Object.keys)return 0===Object.keys(a).length;for(var b in a)if(a.hasOwnProperty(b))return!1;
return!0},v:function(a,b,c,d){if(null==a){if(d)return;b="Invalid ["+c+"] value: ";throw Error(null===a?b+"null":b+"undefined");}if(typeof a!==b)throw Error("Invalid ["+c+"] value: "+a);},Y:function(a,b,c,d,f){n.v(a,b,c,f);d[c]=a},rb:function(a,b){a.forEach(function(c){var d=b[c],f=typeof d;if(null!=d&&"undefined"!==f&&"function"!==f)throw Error("Invalid ["+c+"] value: "+d);})},T:function(a,b,c){b=b?" ["+b+"] ":" ";if("string"===typeof a){try{var d=encodeURIComponent(a)}catch(f){throw Error("Argument"+
b+"not encodable as UTF-8 string");}a=65535;"undefined"!=typeof c&&(a=c);if(d.length>a)throw Error("Argument"+b+"exceeded max length: <"+d.length+">");return d}throw Error("Invalid"+b+"argument: <"+a+">");},kb:function(a,b){return{code:a,message:b||""}},R:function(a,b){a={errorCode:a};"undefined"!==typeof b&&null!=b&&(a.errorMessage=b);return a}};n.checkType=n.v;n.checkTypeAndSet=n.Y;n.checkUTF8=n.T;n.invoke=n.i;n.makeEvent=n.kb;
var r=n.makeErrorEvent=n.R,ca={code:-1,C:"UNAUTHORIZED_SESSION"},da={code:-2,C:"BROKER_CONFIGURATION_NOT_VALID",S:r(9,"MQTT broker configuration not valid")},ea={code:-3,C:"UNAUTHORIZED_CONNECTION"},fa={code:-4,C:"UNAUTHORIZED_PUBLISHING"},ka={code:-5,C:"UNAUTHORIZED_SUBSCRIPTION"},la={code:-6,C:"CONFLICTING_SELECTOR"},ma={code:100,C:"SERVER_ERROR"},na={code:-10,C:"BROKER_CONNECTION_REFUSED"},oa={code:-11,C:"SUCCESSFUL_DISCONNECTION",S:r(0,"Successful disconnection")},pa={code:-12,C:"MQTTCOOL_CONNECTION_ERROR",
S:r(10,"Connection error to MQTT.Cool")},qa={code:-13,C:"MQTT_BROKER_CONNECTION_ERROR",S:r(11,"Connection error to the MQTT broker")},ra={code:-14,C:"MQTTCOOL_DISCONNECTION",S:r(12,"Disconnection from MQTT.Cool")},t={qb:ca,pb:da,Na:ea,Oa:fa,Pa:ka,Fa:la,ca:ma,oa:na,Ka:oa,ua:pa,Ga:qa,va:ra},sa={"-1":ca,"-2":da,"-3":ea,"-4":fa,"-5":ka,"-6":la,"-10":na,"-11":oa,"-12":pa,"-13":qa,"-14":ra};function v(a){return 0<a?ma:sa[String(a)]}function x(a){return a?(a=JSON.parse(a),r(a.code,a.message)):null}
function y(a){this.g=null;if("string"===typeof a){var b=new ArrayBuffer(a.length);this.g=new Uint8Array(b);for(b=0;b<a.length;b++)this.g[b]=a.charCodeAt(b)}else if(a instanceof ArrayBuffer||a instanceof Int8Array||a instanceof Uint8Array||a instanceof Int16Array||a instanceof Uint16Array||a instanceof Int32Array||a instanceof Uint32Array||a instanceof Float32Array||a instanceof Float64Array)this.g=a;else throw Error("Invalid [payload] argument");this.h=void 0;this.o=this.j=!1;this.m=0}
y.prototype={F:function(){return this.g},G:function(){return String.fromCharCode.apply(null,new Uint8Array(this.g.buffer))},u:function(){return this.h},M:function(a){if(0==n.T(a,"destinationName").length)throw Error("Argument [destinationName] must be at least one character long");if(-1!=a.indexOf("#")||-1!=a.indexOf("+"))throw Error("Argument [destinationName] cannot contain wildcard characters");this.h=a},s:function(a){n.v(a,"boolean","duplicate");this.j=a},A:function(){return this.j},L:function(){return this.o},
O:function(a){n.v(a,"boolean","retained");this.o=a},B:function(){return this.m},N:function(a){if("number"===typeof a&&0<=a&&2>=a)this.m=a;else throw Error("Invalid [qos] argument");}};y.prototype._setDuplicate=y.prototype.s;Object.defineProperties(y.prototype,{duplicate:{get:y.prototype.A},retained:{get:y.prototype.L,set:y.prototype.O},qos:{get:y.prototype.B,set:y.prototype.N},destinationName:{get:y.prototype.u,set:y.prototype.M},payloadBytes:{get:y.prototype.F},payloadString:{get:y.prototype.G}});
var xa="object"==typeof process&&(/node(\.exe)?$/.test(process.execPath)||process.node&&process.v8||process.versions&&process.versions.node&&process.versions.v8),z={Z:function(){return xa},ya:function(a){return z.Z()?(new Buffer(a,"base64")).toString():atob(a)},fa:function(a){return z.Z()?(new Buffer(a)).toString("base64"):btoa(a)}};z.isNodeJs=z.Z;z.decodeFromBase64=z.ya;z.encodeToBase64=z.fa;
var A={ea:function(a){for(var b=z.ya(a.payload),c=new Uint8Array(b.length),d=0;d<b.length;d++)c[d]=b.charCodeAt(d);b=new y(c);b.destinationName=a.destinationName;b.qos=parseInt(a.qos,10)||0;b.retained=a.retained||!1;b.s(a.duplicate||!1);return b},za:function(a){return{payload:z.fa(a.payloadString),destinationName:a.destinationName,qos:a.qos,retained:a.retained,duplicate:a.duplicate}}};A.decodeMessageFromJson=A.ea;A.encodeMessageToJson=A.za;var fs=require("fs"),path=require("path");
function B(){try{fs.readdirSync("./mqttcool-storage")}catch(a){fs.mkdirSync("./mqttcool-storage")}}function ya(a){return path.join("./mqttcool-storage",a)}B.prototype={set:function(a,b){fs.writeFileSync(ya(a),b)},get:function(a){try{return fs.readFileSync(ya(a),"utf8")}catch(b){}},remove:function(a){fs.unlinkSync(ya(a))},keys:function(){return fs.readdirSync("./mqttcool-storage")},g:function(){fs.rmdirSync("./mqttcool-storage")}};B.prototype.set=B.prototype.set;B.prototype.get=B.prototype.get;
B.prototype.remove=B.prototype.remove;B.prototype.keys=B.prototype.keys;B.prototype.clearAll=B.prototype.g;var C=m.U("mqtt.cool.store");function D(){this.u=0;this.da=null;this.g=!1;this.K=null}var F={SENT:"S",RECEIVED:"R"};function za(a,b,c){C.l("Making a store key from packetId and state:",b,c);for(var d in F)if(c==F[d])return a.da+"_"+c+"_"+b;C.I("Supplied state is not valid",c);throw Error("Invalid [state]: "+c);}function Aa(a,b){a.h().forEach(function(c){b.apply(this,[c])},a)}
D.prototype={h:function(){return this.K.keys().filter(function(a){return 0==a.indexOf(this.da)},this)},m:function(a,b,c){C.l("Opening the store:",a,b);if(!a)throw C.I("Invalid clientId:",a),Error("Invalid <clientId> argument: "+a);if(!b)throw C.I("Invalid brokerAlias:",b),Error("Invalid <brokerAlias> argument: "+b);this.da=b+"_"+a;c?(C.l("A custom MqttStorage implementation has been supplied"),this.K=c):(C.l("Setting up default MqttStorage implementation"),this.K=new B);a=this.K;try{a.set("__storage_test__",
"__storage_test__");var d=a.keys();C.l("Key size:",d.length);if("__storage_test__"!==a.get("__storage_test__"))throw Error("Assertion failed upon checking MqttStorage.getItem()");a.remove("__storage_test__");var f=!0}catch(k){C.I(k),f=!1}this.g=f;C.$(this.g?"Store opened":"Store is not available");return this.g},store:function(a,b,c){var d=za(this,a.packetId,b);b={seq:++this.u,state:b,pubrecReceived:c||!1,body:a};b=JSON.stringify(b);C.l("Stringified item to be stored:",b);try{this.K.set(d,b),C.l("Item stored with key:",
d)}catch(f){throw C.I(f),Error("The following error occurred while writing into the store: "+f);}C.$("Stored packet body:",a);return d},ka:function(a){try{var b=this.K.get(a);return b?JSON.parse(b):null}catch(c){throw Error("The following error occurred while reading from the store: "+c);}},s:function(a,b){a=za(this,a,b);return this.ka(a)},remove:function(a,b){a=za(this,a,b);try{this.K.remove(a)}catch(c){throw Error("The following error occurred while removing from the store: "+c);}},o:function(a,
b,c){if(this.g){var d=this.h().map(function(f){return this.ka(f)},this).sort(function(f,k){return f.seq-k.seq});d.forEach(function(f){a.apply(c,[f])});0<d.length&&b&&b.apply(c,[])}},size:function(){var a=0;Aa(this,function(){a++});return a},j:function(){this.g&&Aa(this,function(a){this.K.remove(a)})}};D.ITEM_STATE=F;D.prototype.open=D.prototype.m;D.prototype.store=D.prototype.store;D.prototype.retrieve=D.prototype.ka;D.prototype._allKeys=D.prototype.h;D.prototype._getByPacketIdAndState=D.prototype.s;
D.prototype.remove=D.prototype.remove;D.prototype.size=D.prototype.size;D.prototype.processInOrder=D.prototype.o;D.prototype.clear=D.prototype.j;var Ba={qos:{type:"number"},maxFrequency:{type:"number"},onSuccess:{type:"function",nullable:!0},onFailure:{type:"function",nullable:!0},onNotAuthorized:{type:"function",nullable:!0}};
function G(a){this.g={qos:0,maxFrequency:"unlimited"};for(var b in a)Ba[b]&&n.Y(a[b],Ba[b].type,b,this.g,Ba[b].nullable);a=this.g.qos;if(0!==a&&1!==a&&2!==a)throw Error("Invalid [QoS] value: "+a);a=this.g.maxFrequency;if("number"==typeof a&&0>=a)throw Error("maxFrequency must be a positive number: "+a);}
G.prototype={h:function(){return this.g.qos},getRequestedMaxFrequency:function(){return this.g.maxFrequency},D:function(a){n.i(this.g,"onSuccess",[{grantedQos:a}])},H:function(a){n.i(this.g,"onFailure",[n.R(a)])},j:function(a){n.i(this.g,"onNotAuthorized",[a])}};G.prototype.getQoS=G.prototype.h;G.prototype.getRequestedMaxFrequency=G.prototype.getRequestedMaxFrequency;G.prototype.onSuccess=G.prototype.D;G.prototype.onFailure=G.prototype.H;G.prototype.onNotAuthorized=G.prototype.j;
var Ca={onSuccess:{type:"function",nullable:"true"},onFailure:{type:"function",nullable:"true"}};function H(a){this.g=a||{};for(var b in a)Ca[b]&&n.Y(a[b],Ca[b].type,b,this.g,Ca[b].nullable)}H.prototype={D:function(){n.i(this.g,"onSuccess")},H:function(a){n.i(this.g,"onFailure",[a])}};H.prototype.onSuccess=H.prototype.D;H.prototype.onFailure=H.prototype.H;
var Da=m.U("mqtt.cool"),Ea={username:{type:"string",nullable:!0},password:{type:"string",nullable:!0},cleanSession:{type:"boolean"},willMessage:{type:"object",nullable:!0},storage:{type:"object",nullable:!0},storePath:{type:"string",nullable:!0},onSuccess:{type:"function",nullable:!0},onFailure:{type:"function",nullable:!0},onNotAuthorized:{type:"function",nullable:!0}};
function J(a){this.g={cleanSession:!0};for(var b in a)Ea[b]&&n.Y(a[b],Ea[b].type,b,this.g,Ea[b].nullable);this.g.storePath=this.g.storePath||"mqttcool-storage";if((a=this.g.willMessage)&&!a.destinationName)throw Error("Invalid [destinationName] value for [willMessage]: "+a.destinationName);}function Fa(a,b){Da.debug("MqttConnectionOptions."+a+JSON.stringify(b||""))}
J.prototype={u:function(){return this.g.username},s:function(){return this.g.password},h:function(){return this.g.cleanSession},m:function(){return this.g.willMessage},j:function(){return this.g.storage},A:function(){return this.g.storePath},D:function(){Fa("Invoking onSuccess");n.i(this.g,"onSuccess")},H:function(a){Fa("Invoking onFailure with: ",a);n.i(this.g,"onFailure",[a])},o:function(a){Fa("Invoking onNotAuthorized with: ",a);n.i(this.g,"onNotAuthorized",[a])}};J.prototype.getUsername=J.prototype.u;
J.prototype.getPassword=J.prototype.s;J.prototype.getCleanSession=J.prototype.h;J.prototype.getWillMessage=J.prototype.m;J.prototype.getStorage=J.prototype.j;J.prototype.getStorePath=J.prototype.A;J.prototype.onSuccess=J.prototype.D;J.prototype.onFailure=J.prototype.H;J.prototype.onNotAuthorized=J.prototype.o;
var K=m.U("mqtt.cool"),Ga=0,M={DISCONNECTED:0,CONNECTING:1,CONNECTED:2,RETRY:3,RECOVERY:4,DISCONNECTING:5,P:function(a){for(var b in M)if(M[b]==a)return b}},Ha={0:"Connection Accepted",1:"Connection Refused: unacceptable protocol version",2:"Connection Refused: identifier rejected",3:"Connection Refused: server unavailable",4:"Connection Refused: bad user name or password",5:"Connection Refused: not authorized"};function Ia(a){return"undefined"==typeof a||null==a?"#":a?n.T(a):"$"}
function O(a,b){this.body=a;this.V=!1;this.Aa=!0;this.aa="undefined"!=typeof b?b:!1;this.aborted=this.processed=0}function Ja(a,b){a={type:"PUBREL",packetId:a};"undefined"!==typeof b&&(a.restored=b);return new O(a,!1)}function Ka(a,b,c,d){a=new O({type:"SUBSCRIBE",packetId:a,topicFilter:b,qos:c},!0);a.options=d;return a}function La(a,b){return JSON.stringify({connectionId:b,packet:a.body})}
O.prototype={getStatus:function(){return JSON.stringify({type:this.body.type,packetId:this.body.packetId,processed:this.processed,aborted:this.aborted,notified:this.V})},D:function(){},H:function(){}};function Ma(a){this.g=a}function Na(a,b){a.g&&n.i(a.g,"onSubscribe",[b])}function Oa(a,b){a.g&&n.i(a.g,"onSharedUnsubscription",[b])}function eb(a,b,c){a.g&&"function"==typeof a.g.onPubRecReceived?n.i(a.g,"onPubRecReceived",[b,c]):c()}function fb(a,b){a.g&&n.i(a.g,"beforePublishing",[b])}
function gb(a,b){a.g&&n.i(a.g,"onPublish",[b])}Ma.prototype={};function P(a,b,c){K.debug("Creating a new instance of MqttClient");this.ba=a;this.G=b;this.o=c;this.g=new Ma;this.sa=this.ra=this.qa=this.ta=this.wa=this.pa=this.xa=null;hb(this);K.$("New MqttClient instance created:",this.G)}function hb(a){a.B=null;a.j={};a.N={};a.s=[];a.M=0;a.F={};a.u={};a.X={};a.m=null;a.A=null;a.h=M.DISCONNECTED;a.O=Ga++}
function ib(a){if(a.h==M.DISCONNECTED||a.h==M.DISCONNECTING)throw K.I("Invalid state:",M.P(a.h)),Error("Invalid state");}
function Q(a,b,c){for(var d in a.u)a.o.unsubscribe(a.u[d].W);a.B&&a.o.unsubscribe(a.B);a.o.removeListener(a);var f=a.h,k=M.P(f);d=a.m;hb(a);if(b instanceof Error)K.I("Client stop due to an error",b),n.i(a,"onError",[b]);else switch(f){case M.CONNECTING:K.debug('Client in CONNECTING status, interrupt and notify by invoking of "onFailure()"');b==t.Na?(K.debug('Unauthorized connection, interrupt and notify byinvoking of "onNotAuthorized()"'),a=x(c),d.o(a)):b==t.oa?d.H(c):b==t.ca?(a=n.R(b.code,c),d.H(a)):
d.H(b.S);break;case M.CONNECTED:case M.DISCONNECTING:K.debug("Client in "+k+' status, interrupt and notify by invoking "onConnectionLost()"');n.i(a,"onConnectionLost",[b.S]);break;case M.RETRY:case M.RECOVERY:K.debug("Client in "+f+' status, interrupt and notify by invoking "onConnectionLost()"'),n.i(a,"onConnectionLost",[b.S])}}
function R(a,b){K.debug("Sending: "+b.getStatus());var c=La(b,a.L());a.o.sendMessage(c,"PROTOCOL",2E3,{onProcessed:function(){b.aa||T(a,b);b.processed++;K.l("Processed:",b.getStatus());b.ja&&b.ja()},onDiscarded:function(){K.warn("Message discarded")},onAbort:function(d,f){b.aborted++;K.J("Aborted for requester "+a.O+" <sent "+f+">:",b.getStatus());b.Ca&&b.Ca()},onDeny:function(d,f,k){K.warn("Message denied: ("+f+", "+k+")");b.aa&&(K.debug("Removing the message from sent messages, as it requires an ack"),
delete a.j[b.body.packetId]);T(a,b);b.ia&&b.ia(f,k)},onError:function(){K.J("onError while sending < "+b.getStatus()+"> for requestId:"+a.O);b.tb=!0}},!1)}
function jb(a,b){var c=new O({type:"PUBLISH",packetId:null,message:A.za(b)});0<b.qos&&(c.body.packetId=++a.M,c.aa=!0,a.m.h()||(K.debug("Storing message into the Store with SENT state"),a.A.store(c.body,F.SENT)),a.j[c.body.packetId]=c);c.ia=function(d,f){var k=c.body.packetId;k&&!a.m.h()&&(K.debug("Removing the message from the Store"),a.A.remove(k,F.SENT));K.debug('Invoking "onMessageNotAuthorized" callback');v(d)==t.Oa?n.i(a,"onMessageNotAuthorized",[b,x(f)]):K.J("Unmanageable error code",d)};fb(a.g,
c);kb(a,c);K.debug("Scheduled PUBLISH packet for delivery");0==b.qos&&(K.debug('Invoking now "onMessageDelivered" callback, as QoS 0'),setTimeout(function(){lb(a,b)}));gb(a.g,c)}function kb(a,b){a.s.push(b);b.Aa&&R(a,b)}function T(a,b){var c=-1;if("function"==typeof b)for(var d=0;d<a.s.length;d++){if(b(a.s[d])){c=d;break}}else c=a.s.indexOf(b);-1!=c?(a=a.s.splice(c,1),K.l("Removed packet: "+a[0].getStatus()+" from the message queue")):K.l("No packet to remove has been found")}
function mb(a,b,c){b=Ka(++a.M,b,c.h(),c);b.ia=function(d,f){d=x(f);c.j(d)};a.j[b.body.packetId]=b;kb(a,b);K.debug("SUBSCRIBE packet scheduled for delivery");Na(a.g,b)}function nb(a,b,c){var d=a.u[b];if(d){var f=function(k){k.addListener({onUnsubscription:function(){k.removeListener(this);ob(a,b,c)}});a.o.unsubscribe(k)};d.W.isSubscribed()?f(d.W):d.na.push(f)}else ob(a,b,c)}
function ob(a,b,c){var d=c.h(),f="subscribe|"+d+"|"+Ia(b)+"|"+a.L(),k=new e.Subscription("MERGE");k.setItems([f]);k.setFieldSchema("subscribe_schema");k.setDataAdapter("Connector");k.setRequestedSnapshot("no");k.setSelector((a.xa||function(){return Math.random().toString(36).slice(-10)})());k.setRequestedMaxFrequency(0<d?"unfiltered":c.getRequestedMaxFrequency());(f=a.u[b])?f.W=k:a.u[b]={W:k,Ba:{},na:[]};k.addListener({V:!1,onListenStart:function(h){var p=a.g;p.g&&n.i(p.g,"onSharedSubscription",[h])},
onSubscription:function(){K.debug("Subscription on shared connection to <"+b+"> has been submitted to MQTT.Cool");K.debug("Sending SUBSCRIBE packet to enable the MQTT subscription");var h=Ka(-1,b,d);h.aa=!1;R(a,h)},onSubscriptionError:function(h,p){K.J("Received error for subscription on shared connection",h,p);var l=v(h);a.o.unsubscribe(k);switch(l){case t.Pa:h=x(p);c.j(h);break;case t.Fa:K.warn("Conflicting selector, resubmitting a new subscription with a new Selector");ob(a,b,c);break;default:K.J("Unmanageable error code",
h)}},onItemUpdate:function(h){h={suback:parseInt(h.getValue(1),10),seq:h.getValue(2)?parseInt(h.getValue(2),10):null,destinationName:h.getValue(3),payload:h.getValue(4),qos:parseInt(h.getValue(5),10),duplicate:"1"===h.getValue(6),retained:"1"===h.getValue(7)};var p=JSON.stringify(h);K.l("Received event for SharedSubscription",a.L(),p);if(isNaN(h.suback)){p=a.u[b];for(var l in a.u){var u=a.u[l],q;if(q=u!==p)if(q=u.ob>d)a:if(u=u.ab,q=h.destinationName.split("/"),u.length>q.length)q=!1;else{for(var E=
Math.min(q.length,u.length),L=!0,w=0;w<E&&L;w++){if("#"===u[w]){q=!0;break a}L=q[w]===u[w]||"+"===u[w]}q=L&&w==q.length}if(q){K.debug("Found a matching subscription with greater qos, skipping");return}}l=a.X[h.destinationName];if(!l)l={sb:h.destinationName,Da:0,ma:{}},a.X[h.destinationName]=l;else if(h.seq<=l.Da){K.debug("Seq Id "+h.seq+" already received, skipping");return}l.Da=h.seq;l.ma[b]=p;p.Ba[h.destinationName]=l;p.ha<h.qos&&K.debug("Message QoS downgraded from <"+h.qos+"> to <"+p.ha+">");
h.qos=Math.min(h.qos,p.ha);pb(a,h)}else{K.debug("SUBACK event for topicFilter: "+b);l=a.g;l.g&&n.i(l.g,"onSharedSubscriptionAckReceived",[k,h]);p=h.suback;if(0<=p&&2>=p)this.V?K.debug("Subscription already notified"):(K.debug("Subscription not already notified"),l=Math.min(c.h(),p),l<p&&K.debug("Notified QoS downgraded from <"+p+"> to <"+l+">"),this.V=!0,u=a.u[b],u.ha=l,u.ob=p,u.ab=b.split("/"),(p=u.na.shift())&&p(k),c.D(l));else if(128==p)a.o.unsubscribe(k),k.removeListener(this),c.H(p);else throw Error("Unexpected return code: "+
p);l=a.g;l.g&&n.i(l.g,"onSharedSubscriptionAckProcessed",[k,h])}}});a.o.subscribe(k)}function pb(a,b){b=A.ea(b);n.i(a,"onMessageArrived",[b])}
function qb(a,b,c){K.l("Unsubscribing shared subscription from:",b);var d=a.u[b];if(d){K.l("Found subscription on shared connection associated with:",b);var f=function(h){h.addListener({onUnsubscription:function(){delete a.u[b];K.l("Received onUnsubscription() event related to unsubscribing from: ",b);for(var p in d.Ba){var l=a.X[p];delete l.ma[b];n.fb(l.ma)&&delete a.X[p]}h.removeListener(this);c.D();K.l('Removed subscription on shared connection mapped by "'+b+'"');K.info('Successful completion of unsubscription request from "'+
b+'"')}});a.o.unsubscribe(h);Oa(a.g,h);K.info('Submitted unsubscription request from "'+b+'"')},k=d.W;k.isSubscribed()?f(k):d.na.push(f)}else K.J("No subscription on shared connection found for topicFilter:",b),K.debug("Notifying in any case"),Oa(a.g),c.D()}function lb(a,b){var c=b;b instanceof y||(c=A.ea(b));n.i(a,"onMessageDelivered",[c])}
function rb(a,b){K.l("Handling PUBREC for packetId",b);eb(a.g,b,function(){var c=a.j[b];c?(sb(c,2),K.debug('Storing the message into the Store with SENT state and "pubrecReceived" flag set to true'),a.A.store(c.body,F.SENT,!0),R(a,Ja(b)),K.debug("PUBREL packet scheduled for delivery")):K.warn("The arrived PUBREC does not match any PUBLISH message");c=a.g;c.g&&n.i(c.g,"onPubRecProcessed",[b])})}
function tb(a){a.m.h()?a.A&&a.A.j():a.A.o(function(b){var c=new O(b.body,!0),d=c.body.packetId;a.M=d;switch(b.state){case F.SENT:c.body.message.duplicate=!0;var f=null;b.ub?(f=Ja(d,!0),c.processed=1):f=c;K.l("Populating sent messages with the PUBLISH packet with packet id:",d);a.j[d]=c;K.l("Removing duplicates from the message queue");T(a,function(k){return"PUBLISH"==k.body.type&&k.body.packetId==d?!0:!1});K.l("PUBLISH packet scheduled for delivery");f.Aa=!1;kb(a,f);break;case F.RECEIVED:K.l("Insert into into the map of received messages a PUBLISH packet with packet id:",
d),a.N[d]=c}},function(){K.debug("Session restored")})}function sb(a,b,c){var d=a.body.type,f=a.body.message.qos;if("PUBLISH"!==d)throw K.error("The matched packet is a "+d+", but a PUBLISH is expected"),Error("Broken protocol");if(f!=b)throw K.error("The matched packet has QoS "+f+", but "+b+" is expected"),Error("Broken protocol");if(c&&0==a.processed)throw K.error("The matched packet has not been processed yet"),Error("Broken protocol");}
P.prototype={Ma:function(){return this.G},Qa:function(){return this.m},bb:function(){return this.A},La:function(){return this.ba},$a:function(){return this.h},L:function(){var a=this.m.h()?"1":"0";return[this.ba,Ia(this.m.u()),Ia(this.m.s()),a,this.G,this.O].join("|")},cb:function(){if(0<this.s.length)return this.s[this.s.length-1]},Sa:function(){return this.s.length},Ra:function(){return this.s},Za:function(){return this.j},Ya:function(){return this.N},Ja:function(){return this.F},Ia:function(){return this.u},
mb:function(a){this.g=new Ma(a)},nb:function(a){this.xa=a},disconnect:function(){ib(this);if(this.h==M.RETRY||this.h==M.RECOVERY)K.debug("Disconnect invoked forcibly while trying to recover the connection, stopping"),Q(this,t.ua);else if(this.h==M.CONNECTING)K.debug("Disconnect invoked forcibly while connecting, stopping"),Q(this,t.va);else{this.h=M.DISCONNECTING;var a=this,b=new O({type:"DISCONNECT"},!1);b.ja=function(){setTimeout(function(){Q(a,t.Ka)},0)};b.Ca=b.ja;R(this,b);K.debug("DISCONNECT packet scheduled for delivery")}},
subscribe:function(a,b){var c=0;b&&(c=b.qos||c);K.debug("Subscribing to topicFilter <"+a+"> with QoS <"+c+">");ib(this);n.T(a,"topicFilter");b=new G(b);this.G?mb(this,a,b):nb(this,a,b);K.info("Subscription scheduled for being sent to MQTT.Cool")},unsubscribe:function(a,b){ib(this);n.T(a,"topicFilter");b=new H(b);if(this.G){var c=this.F[a],d=++this.M;a=new O({type:"UNSUBSCRIBE",packetId:d,topicFilter:a},!0);a.options=b;a.sourceSubPacket=c;this.j[a.body.packetId]=a;kb(this,a);b=this.g;b.g&&n.i(b.g,
"onUnsubscribe",[a])}else qb(this,a,b)},Ha:function(a,b,c,d){K.l("Sending a message");ib(this);if(0==arguments.length)throw K.error("Invalid arguments length"),Error("Invalid arguments length");if(1==arguments.length){K.debug("Passed one parameter only, checking if is of right type");if(!(a instanceof y))throw Error("Invalid argument");K.debug("The passed parameter is a Message");var f=a;if(!f.destinationName)throw Error("Invalid [destinationName] argument");}else K.debug("Passed "+arguments.length+
" parameters, building a Message instance"),f=new y(b),f.destinationName=a,3<=arguments.length&&(f.qos=c),4<=arguments.length&&(f.retained=d),K.debug("Message instance built");jb(this,f);K.info("Message scheduled for being sent to MQTT.Cool")},connect:function(a){K.debug("Connecting to the MQTT broker through the MQTT.Cool...");if(this.h!=M.DISCONNECTED)throw K.I("Invalid state:",M.P(this.h)),Error("Invalid state");a=new J(a);K.ga()&&K.l("Connection Options built:",JSON.stringify(a.g));if(this.G){K.debug("Opening the store");
var b=new D,c=b.m(this.ba,this.G,a.j());c?(this.A=b,K.debug("The store is enabled")):K.warn("The store is NOT enabled");if(!a.h()&&!c)throw Error("No Local Storage is available");}else{if(!a.h())throw Error("Invalid [cleanSession] value for a shared connection: "+a.h());if(a.m())throw Error("Invalid [willMessage] value for a shared connection: "+a.m());if(a.j())throw Error("Invalid [storage] value for a shared connection: "+a.j());}this.m=a;a=this.m.m()||{qos:"",destinationName:"",retained:"",payloadString:""};
a="connection|"+[String(a.qos),Ia(a.destinationName),!0===a.retained?"1":"0",z.fa(a.payloadString)].join("|")+"|"+this.L();b=this.G?"no":"yes";this.B=new e.Subscription("DISTINCT");this.B.setItems([a]);this.B.setFieldSchema("connection_schema");this.B.setDataAdapter("Connector");this.B.setRequestedSnapshot(b);this.B.setRequestedMaxFrequency("unfiltered");this.B.addListener(this);K.debug("Connection Subscription built");this.h=M.CONNECTING;this.o.addListener(this);this.o.subscribe(this.B);if("DISCONNECTED:TRYING-RECOVERY"==
this.o.getStatus())this.onStatusChange(this.o.getStatus());K.info("Connection request submitted to MQTT.Cool")},onSubscriptionError:function(a,b){K.J("Subscription Error:",n.R(a,b));var c=v(a);c==t.ca&&(b="SERVER_ERROR=> code: <"+a+">, message: <"+b+">");Q(this,c,b)},onItemUpdate:function(a){var b=a.getValue(1);K.debug("Received event: "+b+" on client  "+this.O+", isSnapshot: "+a.isSnapshot());a=JSON.parse(b);try{if("undefined"==typeof a.type)throw Error('Malformed event, no "type" has been specified');
switch(a.type){case "CONNECTION_ERROR":Q(this,t.Ga);break;case "DELIVERY_COMPLETE":if(!this.m.h())throw K.error("Unexpected event"),Error("Event not allowed");var c=a.message;K.l("Completion of message delivery for packetId:",c);var d=this.g;d.g&&n.i(d.g,"onDeliveryCompleteReceived",[c]);var f=this.j[c];null!=f?(K.debug("Removing from sent messages"),delete this.j[c],T(this,f),K.debug("Invoking onMessageDelivered() callback now, as the message has been delivered"),lb(this,f.body.message)):K.warn("No packetId : "+
c+" found!");var k=this.g;k.g&&n.i(k.g,"onDeliveryCompleteProcessed",[c]);break;case "CONTROL_PACKET":var h=a.message,p=h.type;if(!p)throw Error('Malformed packet, no "type" has been specified');if(!this.G&&"CONNACK"!=p)throw K.error("Unexpected event"),Error("Event not allowed");var l=h.packetId;switch(h.type){case "CONNACK":a:{K.debug("Handling CONNACK");var u=this.g;u.g&&n.i(u.g,"onConnAckReceived",[h]);var q=h.returnCode;if(0==q){K.l("Connection Accepted for client:",this.O);c=!1;var E=this.h;
if(E==M.CONNECTING)this.h=M.CONNECTED;else if(E==M.RETRY)this.h=M.CONNECTED,c=!0;else{K.I("Unexpected CONNACK packet as current status is",M.P(this.h));break a}K.l("Status switched from "+M.P(E)+" to "+M.P(this.h));this.G&&tb(this);K.debug("Starting to process pending messages");K.debug("Submitting pending messages");K.debug("Iterating over "+Object.keys(this.F).length+" active subscriptions");K.debug("Active subscriptions "+this.F);for(var L in this.F){var w=++this.M,ta=this.F[L];ta.body.packetId=
w;this.j[w]=ta;this.s.unshift(ta)}K.debug("Queue processing...");if(0==this.s.length)K.debug("No messages to process from the Queue");else{for(var vb=this.s.slice().reverse(),ua;ua=vb.pop();)R(this,ua),K.debug("Submitted packet: "+ua.getStatus());K.debug("Queue processed")}K.info("Pending messages submitted");c?n.i(this,"onReconnectionComplete"):this.m.D()}else K.J("Connection refused with error code:",q),Q(this,t.oa,n.R(q,Ha[q]))}break;case "SUBACK":var S=h.returnCode[0];K.l("Handling SUBACK <"+
S+"> for packetId",l);var Pa=this.g;Pa.g&&n.i(Pa.g,"onSubAckReceived",[l,S]);var I=this.j[l];if(I){var Qa=I.body.type;if("SUBSCRIBE"!==Qa)throw K.error("The matched packet is a "+Qa+", but a SUBSCRIBE is expected"),Error("Broken protocol on SUBACK reception");delete this.j[l];T(this,I);if(128!=S)if(I.V)K.debug("Subscription already notified");else{if(this.m.h()){var ha=I.body.topicFilter;this.F[ha]?K.debug("Subscription to ["+ha+"] filter already tracked."):(this.F[ha]=I,K.l("Tracked subscription to filter:",
ha))}I.V=!0;I.options.D(S)}else I.options.H(S)}else throw K.error("The arrived SUBACK does not match any SUBSCRIBE request"),Error("Broken protocol on SUBACK reception");var Ra=this.g;Ra.g&&n.i(Ra.g,"onSubAckProcessed",[l,S]);break;case "UNSUBACK":K.l("Handling UNSUBACK for packetId",l);var Sa=this.g;Sa.g&&n.i(Sa.g,"onUnsubAckReceived",[l]);var V=this.j[l];if(V){var Ta=V.body.type;if("UNSUBSCRIBE"!==Ta)throw K.error("The matched packet is a "+Ta+", but a UNSUBSCRIBE is expected"),Error("Broken protocol on UNSUBACK reception");
delete this.j[l];T(this,V);var Ua=V.sourceSubPacket;if(Ua){var ia=Ua.body.topicFilter;this.F[ia]?(delete this.F[ia],K.l("Subscription to {topicFilter} removed:",ia)):K.l("No Subscription to:",ia)}else K.warn("The arrived UNSUBACK does not match any SUBSCRIBE request");V.options.D()}else throw K.error("The arrived UNSUBACK does not match any UNSUBSCRIBE request"),Error("Broken protocol on UNSUBACK reception");var Va=this.g;Va.g&&n.i(Va.g,"onUnsubAckProcessed",[l]);break;case "PUBACK":K.l("Handling PUBACK for packetId",
l);var Wa=this.g;Wa.g&&n.i(Wa.g,"onPubAckReceived",[l]);var ja=this.j[l];ja?(sb(ja,1),K.debug("Removing the message from sent messages, as it requires an ack"),delete this.j[l],T(this,ja),lb(this,ja.body.message),K.debug("Removing the message from the Store"),this.A.remove(l,F.SENT)):K.warn("The arrived PUBACK does not match any PUBLISH message");var Xa=this.g;Xa.g&&n.i(Xa.g,"onPubAckProcessed",[l]);break;case "PUBREC":rb(this,l);break;case "PUBREL":K.l("Handling PUBREL for packetId",l);var Ya=this.g;
Ya.g&&n.i(Ya.g,"onPubRelReceived",[l]);var va=this.N[l];va?(sb(va,2,!1),K.debug("Removing the message from the map of received PUBLISH messages"),delete this.N[l],this.A.remove(l,F.RECEIVED),pb(this,va.body.message)):K.warn("The arrived PUBREL does not match any PUBLISH message");R(this,new O({type:"PUBCOMP",packetId:l},!1));K.debug("PUBCOMP packet scheduled for delivery");var Za=this.g;Za.g&&n.i(Za.g,"onPubRelProcessed",[l]);break;case "PUBCOMP":K.l("Handling PUBCOMP for packetId",l);var $a=this.g;
$a.g&&n.i($a.g,"onPubCompReceived",[l]);var W=this.j[l];if(W)sb(W,2),lb(this,W.body.message),delete this.j[l],T(this,W),K.debug("Removing the message from the Store"),this.A.remove(W.body.packetId,F.SENT);else throw K.warn("The arrived PUBCOMP does not match any PUBLISH message"),Error("Broken protocol on PUBCOMP reception");var ab=this.g;ab.g&&n.i(ab.g,"onPubCompProcessed",[l]);break;case "PUBLISH":var N=new O(h),X=N.body.packetId;K.l("Handling PUBLISH with packetId:",X);var bb=this.g;bb.g&&n.i(bb.g,
"onPublishReceived",[h]);var cb=N.body.message.qos;if(0==cb||this.m.h())pb(this,N.body.message);else switch(cb){case 1:R(this,new O({type:"PUBACK",packetId:X},!1));pb(this,N.body.message);break;case 2:K.l("Inserted into the map of received messages a PUBLISH packet with packet id:",X),this.N[X]=N,this.A.store(N.body,F.RECEIVED),R(this,new O({type:"PUBREC",packetId:X},!1))}var db=this.g;db.g&&n.i(db.g,"onPublishProcessed",[N])}}}catch(wa){E=wa,wa instanceof Error||(E=Error(wa)),Q(this,E)}},onServerError:function(a,
b){K.error("errorCode"+a+", errorMessage:"+b)},onStatusChange:function(a){K.l("Status changed --\x3e",a);if(0==a.indexOf("CONNECTED:")&&this.h==M.RECOVERY)this.h=M.CONNECTED,n.i(this,"onReconnectionComplete");else if("DISCONNECTED:WILL-RETRY"==a||"DISCONNECTED:TRYING-RECOVERY"==a)try{var b=this.h,c=M.P(b);K.debug("Handling connection recovery while in status "+c+" and LS in status "+a);switch(b){case M.CONNECTING:Q(this,t.ua);break;case M.CONNECTED:case M.RETRY:case M.RECOVERY:"DISCONNECTED:WILL-RETRY"==
a?(K.debug("Switching status to RETRY"),this.h=M.RETRY):"DISCONNECTED:TRYING-RECOVERY"==a&&(K.debug("Switching status to RECOVERY"),this.h=M.RECOVERY);n.i(this,"onReconnectionStart");break;default:K.J("No action found for status:",c)}}catch(d){a=d,a instanceof Error||(a=Error(d)),Q(this,a)}else"DISCONNECTED"==a&&Q(this,t.va)},eb:function(a){n.v(a,"function","onConnectionLost",!0);this.pa=a},Ta:function(){return this.pa},lb:function(a){n.v(a,"function","onReconnectionStart",!0);this.wa=a},Xa:function(){return this.wa},
jb:function(a){n.v(a,"function","onReconnectionComplete",!0);this.ta=a},Wa:function(){return this.ta},gb:function(a){n.v(a,"function","onMessageArrived",!0);this.qa=a},Ua:function(){return this.qa},hb:function(a){n.v(a,"function","onMessageDelivered",!0);this.ra=a},Ea:function(){return this.ra},ib:function(a){n.v(a,"function","onMessageNotAuthorized",!0);this.sa=a},Va:function(){return this.sa}};P.STATUS=M;P.prototype.onItemUpdate=P.prototype.onItemUpdate;P.prototype._getClientId=P.prototype.Ma;
P.prototype._getConnectionId=P.prototype.L;P.prototype._getConnectionOptions=P.prototype.Qa;P.prototype._getStore=P.prototype.bb;P.prototype._getBrokerAddress=P.prototype.La;P.prototype._getStatus=P.prototype.$a;P.prototype._getSent=P.prototype.Za;P.prototype._getReceived=P.prototype.Ya;P.prototype._getMessageQueueSize=P.prototype.Sa;P.prototype._getMessageQueue=P.prototype.Ra;P.prototype._peek=P.prototype.cb;P.prototype._getActiveSubscriptions=P.prototype.Ja;
P.prototype._getActiveSharedSubscriptions=P.prototype.Ia;P.prototype._setProtocolListener=P.prototype.mb;P.prototype._setSelectorStrategy=P.prototype.nb;P.prototype.connect=P.prototype.connect;P.prototype.disconnect=P.prototype.disconnect;P.prototype.send=P.prototype.Ha;P.prototype.subscribe=P.prototype.subscribe;P.prototype.unsubscribe=P.prototype.unsubscribe;
Object.defineProperties(P.prototype,{onConnectionLost:{set:P.prototype.eb,get:P.prototype.Ta},onReconnectionStart:{set:P.prototype.lb,get:P.prototype.Xa},onReconnectionComplete:{set:P.prototype.jb,get:P.prototype.Wa},onMessageArrived:{set:P.prototype.gb,get:P.prototype.Ua},onMessageDelivered:{set:P.prototype.hb,get:P.prototype.Ea},onMessageNotAuthorized:{set:P.prototype.ib,get:P.prototype.Va}});function U(a,b){this.h=a;this.g=b}var ub=["tcp:","mqtt:","mqtts:","ssl:"];
U.prototype={j:function(a,b){n.v(a,"string","brokerReference");if(z.Z())var c=require("url").parse(a);else c=document.createElement("a"),c.href=a;if(-1==ub.indexOf(c.protocol)&&!/^[A-Za-z0-9_-]+$/.test(a))throw Error("Invalid [brokerReference] argument: <"+a+">");b&&n.T(b,"clientId");return new P(a,b||"",this.g)},close:function(){this.g.disconnect()},toString:function(){return String(this.h)}};U.prototype.createClient=U.prototype.j;U.prototype.close=U.prototype.close;var Y=m.U("mqtt.cool");Y.info("Logger SETUP");
var wb=0;function xb(a,b){return new e.LightstreamerClient(a,b)}
function Z(a,b,c,d){Y.debug("Creating a new MQTTCoolSession");if(2<=arguments.length&&4>=arguments.length)if(2==arguments.length){n.v(arguments[0],"string","serverAddress");n.v(arguments[1],"object","listener");var f=arguments[0];var k=arguments[1]}else if(3==arguments.length){n.v(arguments[0],"string","serverAddress");n.v(arguments[1],"string","username",!0);n.v(arguments[2],"object","listener");f=arguments[0];var h=arguments[1];k=arguments[2]}else{if(4==arguments.length){n.v(arguments[0],"string",
"serverAddress");n.v(arguments[1],"string","username",!0);n.v(arguments[2],"string","password",!0);n.v(arguments[3],"object","listener");f=arguments[0];h=arguments[1];var p=arguments[2];k=arguments[3]}}else throw Y.error("ERROR - Please supply the correct number of arguments"),Error("Please supply the correct number of arguments");var l=null;l=n.i(Z,"__lightstreamerFactory",[f,Z.ADAPTER_SET]);l.connectionDetails.setUser(h);l.connectionDetails.setPassword(p);f=wb++;var u=new U(f,l);Y.debug("MQTTCoolSession created");
l.addListener({onServerError:function(q,E){var L=v(q),w;L!==t.ca?w=x(E):w=n.R(q,E);l.removeListener(this);l.disconnect();n.i(k,"onConnectionFailure",[L.C,w?w.errorCode:void 0,w?w.errorMessage:void 0])},onListenStart:function(q){Y.debug("Starting ConnectionListener");n.i(k,"onLsClient",[q])},onStatusChange:function(q){switch(q){case "CONNECTED:WS-STREAMING":case "CONNECTED:HTTP-STREAMING":case "CONNECTED:WS-POLLING":case "CONNECTED:HTTP-POLLING":n.i(k,"onConnectionSuccess",[u]),l.removeListener(this)}}});
Y.debug("Connecting to the MQTT.Cool server");l.connect();Y.debug("Connection request submitted")}Z.__lightstreamerFactory=xb;Z.__resetFactory=function(){Z.__lightstreamerFactory=xb;Z.ADAPTER_SET="MQTT"};Z.LIB_NAME="nodejs_client";Z.LIB_VERSION="2.0.0 build 217";Z.ADAPTER_SET="MQTT";var yb=e.LightstreamerClient.setLoggerProvider;e.LightstreamerClient.setLoggerProvider=function(a){m.setLoggerProvider(a);yb(a)};
module.exports={LightstreamerClient:e.LightstreamerClient,Subscription:e.Subscription,SimpleLoggerProvider:e.SimpleLoggerProvider,ConsoleAppender:e.ConsoleAppender,LightstreamerMQTT:g,openSession:Z,Message:y}
